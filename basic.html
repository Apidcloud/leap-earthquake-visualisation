<!DOCTYPE html>
<html>
	<head>
      <meta charset=utf-8>
    <title>Finger based box rotation demo</title>
		<script>
			var ws;
			// Support both the WebSocket and MozWebSocket objects
			if ((typeof(WebSocket) == 'undefined') &&
				(typeof(MozWebSocket) != 'undefined')) {
			  WebSocket = MozWebSocket;
			}
			// Create the socket with event handlers
			function init() {
			  //Create and open the socket
			  ws = new WebSocket("ws://localhost:6437/v4.json");
			  // On successful connection
			  ws.onopen = function(event) {
				document.getElementById("main").style.visibility = "visible";
        document.getElementById("connection").innerHTML = "WebSocket connection open!";
        var backgroundMessage = JSON.stringify({background: true});
        ws.send(backgroundMessage); // Get frames in background
        console.log("open");
			  };
			  // On message received
			  ws.onmessage = function(event) {
				var obj = JSON.parse(event.data);
				var outputdiv = document.getElementById("output");
				outputdiv.innerHTML = "";
				try{
					var fingervec = obj['pointables'][0]['direction'];
				}
				catch(err){
					//don't care if no data, just don't complain for now
				}
				if (fingervec !== undefined){
					window['rotx'] = fingervec[0];
					window['roty'] = fingervec[1];
					window['rotz'] = fingervec[2];
				}
				for (var rotation in fingervec){
					outputdiv.innerHTML += fingervec[rotation]+"<br>";
				}
			  };
			  // On socket close
			  ws.onclose = function(event) {
				ws = null;
				document.getElementById("main").style.visibility = "hidden";
				document.getElementById("connection").innerHTML = "WebSocket connection closed";
			  }
			  //On socket error
			  ws.onerror = function(event) {
				alert("Received error");
			  };
			}
    </script>
    <script src="https://threejs.org/build/three.js"></script>
	</head>
	<body onload="init();">
		
	<div id="connection">WebSocket not connected</div>
		<div id="main" style="visibility:hidden">
			<p>JSON Frame data:</p>
			<div id="output"></div>
    </div>
		<script>
			var camera, scene, renderer;
			var geometry, material, mesh;
			threeinit();
			threeanimate();
			function threeinit() {
				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.z = 1000;
				scene = new THREE.Scene();
				geometry = new THREE.CubeGeometry( 500, 500, 500 );
				material = new THREE.MeshBasicMaterial( { color: 0x0000ff, wireframe: true } );
				mesh = new THREE.Mesh( geometry, material );
        scene.add( mesh );
        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );
			}
			function threeanimate() {
				// note: three.js includes requestAnimationFrame shim
				requestAnimationFrame( threeanimate );
				mesh.rotation.x = window['roty'];
				mesh.rotation.y = -window['rotx'];
				mesh.rotation.z = -window['rotz'];
				renderer.render( scene, camera );
			}
		</script>
	</body>
</html>